## ä»€ä¹ˆæ˜¯æ­»é”ï¼Ÿ

**æ­»é”** æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªçº¿ç¨‹/è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› **äº‰å¤ºèµ„æº**è€Œé€ æˆçš„ä¸€ç§**ç›¸äº’ç­‰å¾…**çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›å¹²æ¶‰ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•ç»§ç»­æ‰§è¡Œä¸‹å»ã€‚

## æ­»é”çš„å¿…è¦æ¡ä»¶ï¼ˆCoffmanæ¡ä»¶ï¼‰

æ­»é”å¿…é¡»åŒæ—¶æ»¡è¶³ä»¥ä¸‹å››ä¸ªæ¡ä»¶ï¼š

1. **äº’æ–¥æ¡ä»¶**ï¼šèµ„æºä¸èƒ½è¢«å…±äº«ï¼Œåªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ç‹¬å 
2. **å æœ‰ä¸”ç­‰å¾…**ï¼šè¿›ç¨‹å·²å æœ‰éƒ¨åˆ†èµ„æºï¼ŒåŒæ—¶è¯·æ±‚æ–°èµ„æº
3. **ä¸å¯æŠ¢å **ï¼šèµ„æºä¸èƒ½è¢«å¼ºåˆ¶ä»æŒæœ‰è¿›ç¨‹æ‰‹ä¸­å‰¥å¤º
4. **å¾ªç¯ç­‰å¾…**ï¼šå­˜åœ¨ä¸€ä¸ªè¿›ç¨‹-èµ„æºçš„å¾ªç¯ç­‰å¾…é“¾

## Pythonç»å…¸æ­»é”åœºæ™¯ä¸¾ä¾‹

### åœºæ™¯1ï¼šå“²å­¦å®¶å°±é¤é—®é¢˜ï¼ˆæœ€ç»å…¸ï¼‰

```python
import threading
import time

# ç»å…¸çš„æ­»é”åœºæ™¯ï¼šå“²å­¦å®¶å°±é¤é—®é¢˜
class PhilosopherDining:
    def __init__(self, num_philosophers=5):
        self.forks = [threading.Lock() for _ in range(num_philosophers)]
        self.philosophers = []
  
    def philosopher(self, id):
        """å“²å­¦å®¶çº¿ç¨‹ï¼šæ€è€ƒ -> æ‹¿å·¦è¾¹å‰å­ -> æ‹¿å³è¾¹å‰å­ -> åƒé¥­"""
        left_fork = self.forks[id]
        right_fork = self.forks[(id + 1) % len(self.forks)]
  
        while True:
            # æ€è€ƒ
            print(f"å“²å­¦å®¶ {id} æ­£åœ¨æ€è€ƒ...")
            time.sleep(0.1)
      
            # å°è¯•æ‹¿å‰å­åƒé¥­ - è¿™ç§é¡ºåºå¯èƒ½å¯¼è‡´æ­»é”ï¼
            print(f"å“²å­¦å®¶ {id} å°è¯•æ‹¿å·¦è¾¹å‰å­...")
            left_fork.acquire()
            print(f"å“²å­¦å®¶ {id} æ‹¿åˆ°äº†å·¦è¾¹å‰å­")
      
            time.sleep(0.1)  # å¢åŠ æ­»é”æ¦‚ç‡
      
            print(f"å“²å­¦å®¶ {id} å°è¯•æ‹¿å³è¾¹å‰å­...")
            right_fork.acquire()
            print(f"å“²å­¦å®¶ {id} æ‹¿åˆ°äº†å³è¾¹å‰å­ï¼Œå¼€å§‹åƒé¥­")
      
            # åƒé¥­
            time.sleep(0.1)
            print(f"å“²å­¦å®¶ {id} åƒå®Œäº†ï¼Œæ”¾ä¸‹å‰å­")
      
            # é‡Šæ”¾å‰å­
            right_fork.release()
            left_fork.release()

def test_philosopher_deadlock():
    """æµ‹è¯•å“²å­¦å®¶å°±é¤é—®é¢˜çš„æ­»é”"""
    print("=== å“²å­¦å®¶å°±é¤é—®é¢˜ï¼ˆå¯èƒ½äº§ç”Ÿæ­»é”ï¼‰===")
    dining = PhilosopherDining(5)
  
    # åˆ›å»º5ä¸ªå“²å­¦å®¶çº¿ç¨‹
    threads = []
    for i in range(5):
        t = threading.Thread(target=dining.philosopher, args=(i,))
        t.daemon = True  # è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ï¼Œä¾¿äºç¨‹åºé€€å‡º
        threads.append(t)
  
    for t in threads:
        t.start()
  
    # è¿è¡Œä¸€æ®µæ—¶é—´è§‚å¯Ÿæ­»é”
    time.sleep(3)
    print("\nâš ï¸ å¦‚æœç¨‹åºå¡ä½ï¼Œè¯´æ˜å‘ç”Ÿäº†æ­»é”ï¼")
```

### åœºæ™¯2ï¼šé“¶è¡Œå®¶ç®—æ³•é—®é¢˜ï¼ˆèµ„æºç«äº‰ï¼‰

```python
import threading
import time

class BankDeadlock:
    """æ¨¡æ‹Ÿé“¶è¡Œè´¦æˆ·è½¬è´¦æ­»é”"""
    def __init__(self):
        self.account_a = threading.Lock()
        self.account_b = threading.Lock()
        self.balance_a = 1000
        self.balance_b = 1000
  
    def transfer_a_to_b(self, amount):
        """ä»Aè½¬è´¦åˆ°B - é”™è¯¯çš„é¡ºåº"""
        print(f"çº¿ç¨‹1: å°è¯•é”å®šè´¦æˆ·A...")
        self.account_a.acquire()
        print(f"çº¿ç¨‹1: è´¦æˆ·Aå·²é”å®šï¼Œä½™é¢: {self.balance_a}")
        time.sleep(0.1)  # æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿ
  
        print(f"çº¿ç¨‹1: å°è¯•é”å®šè´¦æˆ·B...")
        self.account_b.acquire()
        print(f"çº¿ç¨‹1: è´¦æˆ·Bå·²é”å®š")
  
        # æ‰§è¡Œè½¬è´¦
        if self.balance_a >= amount:
            self.balance_a -= amount
            self.balance_b += amount
            print(f"çº¿ç¨‹1: è½¬è´¦æˆåŠŸ! Aä½™é¢: {self.balance_a}, Bä½™é¢: {self.balance_b}")
  
        self.account_b.release()
        self.account_a.release()
  
    def transfer_b_to_a(self, amount):
        """ä»Bè½¬è´¦åˆ°A - é”™è¯¯çš„é¡ºåº"""
        print(f"çº¿ç¨‹2: å°è¯•é”å®šè´¦æˆ·B...")
        self.account_b.acquire()
        print(f"çº¿ç¨‹2: è´¦æˆ·Bå·²é”å®šï¼Œä½™é¢: {self.balance_b}")
        time.sleep(0.1)  # æ¨¡æ‹Ÿå¤„ç†å»¶è¿Ÿ
  
        print(f"çº¿ç¨‹2: å°è¯•é”å®šè´¦æˆ·A...")
        self.account_a.acquire()
        print(f"çº¿ç¨‹2: è´¦æˆ·Aå·²é”å®š")
  
        # æ‰§è¡Œè½¬è´¦
        if self.balance_b >= amount:
            self.balance_b -= amount
            self.balance_a += amount
            print(f"çº¿ç¨‹2: è½¬è´¦æˆåŠŸ! Aä½™é¢: {self.balance_a}, Bä½™é¢: {self.balance_b}")
  
        self.account_a.release()
        self.account_b.release()

def test_bank_transfer_deadlock():
    """æµ‹è¯•é“¶è¡Œè½¬è´¦æ­»é”"""
    print("\n=== é“¶è¡Œè½¬è´¦æ­»é”ç¤ºä¾‹ ===")
    bank = BankDeadlock()
  
    # åˆ›å»ºä¸¤ä¸ªè½¬è´¦çº¿ç¨‹
    thread1 = threading.Thread(target=bank.transfer_a_to_b, args=(100,))
    thread2 = threading.Thread(target=bank.transfer_b_to_a, args=(150,))
  
    thread1.start()
    thread2.start()
  
    thread1.join(timeout=2)
    thread2.join(timeout=2)
  
    if thread1.is_alive() or thread2.is_alive():
        print("âŒ æ£€æµ‹åˆ°æ­»é”ï¼çº¿ç¨‹æ— æ³•å®Œæˆæ‰§è¡Œ")
```

### åœºæ™¯3ï¼šåµŒå¥—é”ï¼ˆé€’å½’é”é—®é¢˜ï¼‰

```python
import threading

class NestedLockDeadlock:
    """åµŒå¥—é”å¯¼è‡´çš„æ­»é”"""
    def __init__(self):
        self.lock_a = threading.Lock()
        self.lock_b = threading.Lock()
  
    def method1(self):
        """æ–¹æ³•1ï¼šå…ˆè·å–lock_aï¼Œå†è·å–lock_b"""
        print("æ–¹æ³•1: ç­‰å¾…lock_a...")
        self.lock_a.acquire()
        print("æ–¹æ³•1: è·å¾—lock_a")
  
        # æ¨¡æ‹Ÿä¸€äº›å¤„ç†
        import time
        time.sleep(0.1)
  
        print("æ–¹æ³•1: ç­‰å¾…lock_b...")
        self.lock_b.acquire()
        print("æ–¹æ³•1: è·å¾—lock_bï¼Œæ‰§è¡Œæ“ä½œ")
  
        # æ‰§è¡Œæ“ä½œ
        time.sleep(0.1)
  
        self.lock_b.release()
        self.lock_a.release()
        print("æ–¹æ³•1: å®Œæˆ")
  
    def method2(self):
        """æ–¹æ³•2ï¼šå…ˆè·å–lock_bï¼Œå†è·å–lock_a"""
        print("æ–¹æ³•2: ç­‰å¾…lock_b...")
        self.lock_b.acquire()
        print("æ–¹æ³•2: è·å¾—lock_b")
  
        # æ¨¡æ‹Ÿä¸€äº›å¤„ç†
        import time
        time.sleep(0.1)
  
        print("æ–¹æ³•2: ç­‰å¾…lock_a...")
        self.lock_a.acquire()
        print("æ–¹æ³•2: è·å¾—lock_aï¼Œæ‰§è¡Œæ“ä½œ")
  
        # æ‰§è¡Œæ“ä½œ
        time.sleep(0.1)
  
        self.lock_a.release()
        self.lock_b.release()
        print("æ–¹æ³•2: å®Œæˆ")

def test_nested_lock_deadlock():
    """æµ‹è¯•åµŒå¥—é”æ­»é”"""
    print("\n=== åµŒå¥—é”æ­»é”ç¤ºä¾‹ ===")
    obj = NestedLockDeadlock()
  
    thread1 = threading.Thread(target=obj.method1)
    thread2 = threading.Thread(target=obj.method2)
  
    thread1.start()
    thread2.start()
  
    # ç­‰å¾…çº¿ç¨‹å®Œæˆï¼ˆå¦‚æœå‘ç”Ÿæ­»é”åˆ™ä¸ä¼šå®Œæˆï¼‰
    thread1.join(timeout=2)
    thread2.join(timeout=2)
  
    if thread1.is_alive() or thread2.is_alive():
        print("âŒ æ£€æµ‹åˆ°æ­»é”ï¼")
        print("æ­»é”åŸå› : method1æŒæœ‰lock_aç­‰å¾…lock_bï¼Œmethod2æŒæœ‰lock_bç­‰å¾…lock_a")
```

## æ­»é”è§£å†³æ–¹æ¡ˆç¤ºä¾‹

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨è¶…æ—¶æœºåˆ¶

```python
import threading
import time

class TimeoutSolution:
    """ä½¿ç”¨è¶…æ—¶é¿å…æ­»é”"""
    def __init__(self):
        self.lock_a = threading.Lock()
        self.lock_b = threading.Lock()
  
    def safe_transfer(self, from_account, to_account, amount):
        """å®‰å…¨çš„è½¬è´¦æ–¹æ³•ï¼šä½¿ç”¨è¶…æ—¶"""
        acquired_a = False
        acquired_b = False
  
        try:
            # å°è¯•è·å–ç¬¬ä¸€ä¸ªé”ï¼Œè®¾ç½®è¶…æ—¶
            print(f"å°è¯•è·å–é” {from_account}...")
            if from_account == 'A':
                acquired_a = self.lock_a.acquire(timeout=1)
            else:
                acquired_b = self.lock_b.acquire(timeout=1)
      
            if not (acquired_a or acquired_b):
                print("è·å–ç¬¬ä¸€ä¸ªé”è¶…æ—¶ï¼Œæ”¾å¼ƒæ“ä½œ")
                return False
      
            # è·å–ç¬¬äºŒä¸ªé”ï¼Œè®¾ç½®è¶…æ—¶
            print(f"å°è¯•è·å–é” {to_account}...")
            time.sleep(0.5)  # æ¨¡æ‹Ÿå»¶è¿Ÿå¢åŠ æ­»é”å¯èƒ½æ€§
      
            if to_account == 'A':
                acquired_a = self.lock_a.acquire(timeout=1)
            else:
                acquired_b = self.lock_b.acquire(timeout=1)
      
            if not (acquired_a and acquired_b):
                print("è·å–ç¬¬äºŒä¸ªé”è¶…æ—¶ï¼Œé‡Šæ”¾å·²æŒæœ‰çš„é”")
                return False
      
            # æ‰§è¡Œè½¬è´¦
            print(f"æ‰§è¡Œè½¬è´¦: {from_account} -> {to_account} é‡‘é¢: {amount}")
            return True
      
        finally:
            # ç¡®ä¿é‡Šæ”¾æ‰€æœ‰å·²è·å–çš„é”
            if acquired_a:
                self.lock_a.release()
            if acquired_b:
                self.lock_b.release()
```

### æ–¹æ¡ˆ2ï¼šå›ºå®šé”é¡ºåºï¼ˆæœ€å¸¸ç”¨è§£å†³æ–¹æ¡ˆï¼‰

```python
class OrderedLockSolution:
    """é€šè¿‡å›ºå®šé”é¡ºåºé¿å…æ­»é”"""
    def __init__(self):
        self.account_a = threading.Lock()
        self.account_b = threading.Lock()
        self.balance_a = 1000
        self.balance_b = 1000
  
    def ordered_transfer(self, from_id, to_id, amount):
        """
        ä½¿ç”¨å›ºå®šé¡ºåºè·å–é”ï¼š
        æ€»æ˜¯å…ˆè·å–ç¼–å·å°çš„é”ï¼Œå†è·å–ç¼–å·å¤§çš„é”
        """
        # ç¡®å®šé”çš„é¡ºåº
        first_lock = self.account_a if from_id < to_id else self.account_b
        second_lock = self.account_b if from_id < to_id else self.account_a
  
        # æŒ‰å›ºå®šé¡ºåºè·å–é”
        print(f"æŒ‰é¡ºåºè·å–é”: å…ˆé”{from_id if from_id < to_id else to_id}")
        first_lock.acquire()
        try:
            print(f"å†é”{to_id if from_id < to_id else from_id}")
            second_lock.acquire()
            try:
                # æ‰§è¡Œè½¬è´¦
                print(f"æ‰§è¡Œè½¬è´¦: è´¦æˆ·{from_id} -> è´¦æˆ·{to_id} é‡‘é¢: {amount}")
                return True
            finally:
                second_lock.release()
        finally:
            first_lock.release()

def test_ordered_solution():
    """æµ‹è¯•æœ‰åºé”è§£å†³æ–¹æ¡ˆ"""
    print("\n=== æœ‰åºé”è§£å†³æ–¹æ¡ˆ ===")
    bank = OrderedLockSolution()
  
    # åˆ›å»ºå¤šä¸ªè½¬è´¦çº¿ç¨‹
    threads = []
    transfers = [(1, 2, 100), (2, 1, 150), (1, 2, 200)]
  
    for from_id, to_id, amount in transfers:
        t = threading.Thread(
            target=bank.ordered_transfer,
            args=(from_id, to_id, amount)
        )
        threads.append(t)
        t.start()
  
    for t in threads:
        t.join()
  
    print("âœ… æ‰€æœ‰è½¬è´¦å®Œæˆï¼Œæ— æ­»é”å‘ç”Ÿ")
```

### æ–¹æ¡ˆ3ï¼šä¸Šä¸‹æ–‡ç®¡ç†å™¨ + ç»Ÿä¸€é”ç®¡ç†å™¨

```python
import threading


class ContextManagerSolution:
    """ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨é¿å…æ­»é”çš„è§£å†³æ–¹æ¡ˆ"""

    def __init__(self):
        self.account_a = threading.Lock()
        self.account_b = threading.Lock()
        self.balance_a = 1000
        self.balance_b = 1000

    def transfer_with_context_manager(self, from_account, to_account, amount):
        """
        æ–¹æ³•1ï¼šä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ + ç»Ÿä¸€é”é¡ºåº
        è¿™æ˜¯æœ€å®‰å…¨å’Œæ¨èçš„æ–¹å¼
        """
        # ç¡®å®šé”çš„é¡ºåºï¼šæ€»æ˜¯å…ˆé”ç¼–å·å°çš„è´¦æˆ·
        if from_account == "A" and to_account == "B":
            # A -> B: å…ˆé”Aï¼Œå†é”B
            with self.account_a:
                with self.account_b:
                    # æ‰§è¡Œè½¬è´¦
                    if self.balance_a >= amount:
                        self.balance_a -= amount
                        self.balance_b += amount
                        print(
                            f"âœ… è½¬è´¦æˆåŠŸ: {from_account} -> {to_account}, é‡‘é¢: {amount}"
                        )
                        print(
                            f"   è´¦æˆ·Aä½™é¢: {self.balance_a}, è´¦æˆ·Bä½™é¢: {self.balance_b}"
                        )
                        return True
                    else:
                        print(f"âŒ è½¬è´¦å¤±è´¥: è´¦æˆ·{from_account}ä½™é¢ä¸è¶³")
                        return False

        elif from_account == "B" and to_account == "A":
            # B -> A: ä¹Ÿå…ˆé”Aï¼Œå†é”Bï¼ˆç»Ÿä¸€é¡ºåºï¼ï¼‰
            with self.account_a:
                with self.account_b:
                    # æ‰§è¡Œè½¬è´¦
                    if self.balance_b >= amount:
                        self.balance_b -= amount
                        self.balance_a += amount
                        print(
                            f"âœ… è½¬è´¦æˆåŠŸ: {from_account} -> {to_account}, é‡‘é¢: {amount}"
                        )
                        print(
                            f"   è´¦æˆ·Aä½™é¢: {self.balance_a}, è´¦æˆ·Bä½™é¢: {self.balance_b}"
                        )
                        return True
                    else:
                        print(f"âŒ è½¬è´¦å¤±è´¥: è´¦æˆ·{from_account}ä½™é¢ä¸è¶³")
                        return False


def explain_context_manager():
    """è¯¦ç»†è§£é‡Šä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„å·¥ä½œåŸç†"""
    print("=" * 60)
    print("ğŸ“š ä¸Šä¸‹æ–‡ç®¡ç†å™¨ (Context Manager) è¯¦è§£")
    print("=" * 60)

    print("\n1ï¸âƒ£ ä»€ä¹ˆæ˜¯ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Ÿ")
    print("   Pythonçš„ `with` è¯­å¥ç”¨äºç®¡ç†èµ„æºï¼Œç¡®ä¿èµ„æºåœ¨ä½¿ç”¨åæ­£ç¡®é‡Šæ”¾")
    print("   threading.Lock() æ”¯æŒä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®")

    print("\n2ï¸âƒ£ æ‰‹åŠ¨ç®¡ç†é” vs ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š")
    print("\n   âŒ æ‰‹åŠ¨ç®¡ç†ï¼ˆå®¹æ˜“å‡ºé”™ï¼‰ï¼š")
    print("      lock.acquire()")
    print("      try:")
    print("          # æ‰§è¡Œæ“ä½œ")
    print("      finally:")
    print("          lock.release()  # å¦‚æœå¿˜è®°é‡Šæ”¾ï¼Œä¼šå¯¼è‡´æ­»é”")

    print("\n   âœ… ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆè‡ªåŠ¨ç®¡ç†ï¼‰ï¼š")
    print("      with lock:")
    print("          # æ‰§è¡Œæ“ä½œ")
    print("      # è‡ªåŠ¨é‡Šæ”¾é”ï¼Œå³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¼šé‡Šæ”¾")

    print("\n3ï¸âƒ£ åµŒå¥—ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼š")
    print("   with lock_a:")
    print("       with lock_b:")
    print("           # æ‰§è¡Œæ“ä½œ")
    print("       # lock_b è‡ªåŠ¨é‡Šæ”¾")
    print("   # lock_a è‡ªåŠ¨é‡Šæ”¾")

    print("\n4ï¸âƒ£ ä¸Šä¸‹æ–‡ç®¡ç†å™¨çš„ä¼˜åŠ¿ï¼š")
    print("   âœ“ è‡ªåŠ¨é‡Šæ”¾ï¼šå³ä½¿å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¼šé‡Šæ”¾é”")
    print("   âœ“ ä»£ç ç®€æ´ï¼šä¸éœ€è¦ try-finally å—")
    print("   âœ“ ä¸æ˜“å‡ºé”™ï¼šä¸ä¼šå¿˜è®°é‡Šæ”¾é”")
    print("   âœ“ å¯è¯»æ€§å¼ºï¼šä»£ç ç»“æ„æ¸…æ™°")


def test_context_manager_solution():
    """æµ‹è¯•ä¸Šä¸‹æ–‡ç®¡ç†å™¨è§£å†³æ–¹æ¡ˆ"""
    print("\n" + "=" * 60)
    print("ğŸ§ª æµ‹è¯•ï¼šä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ + ç»Ÿä¸€é”é¡ºåº")
    print("=" * 60)

    bank = ContextManagerSolution()

    def transfer_a_to_b():
        print("\n[çº¿ç¨‹1] å¼€å§‹æ‰§è¡Œ: A -> B è½¬è´¦ 100")
        bank.transfer_with_context_manager("A", "B", 100)

    def transfer_b_to_a():
        print("\n[çº¿ç¨‹2] å¼€å§‹æ‰§è¡Œ: B -> A è½¬è´¦ 150")
        bank.transfer_with_context_manager("B", "A", 150)

    # åˆ›å»ºä¸¤ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œ
    thread1 = threading.Thread(target=transfer_a_to_b)
    thread2 = threading.Thread(target=transfer_b_to_a)

    thread1.start()
    thread2.start()

    thread1.join()
    thread2.join()

    print("\nâœ… æ‰€æœ‰è½¬è´¦å®Œæˆï¼Œæœªå‘ç”Ÿæ­»é”ï¼")
    print(f"æœ€ç»ˆä½™é¢ - è´¦æˆ·A: {bank.balance_a}, è´¦æˆ·B: {bank.balance_b}")


if __name__ == "__main__":
    explain_context_manager()
    test_context_manager_solution()

```


### é¢„é˜²ç­–ç•¥ï¼š

1. **å›ºå®šé”é¡ºåº**ï¼šä¸ºæ‰€æœ‰èµ„æºå®šä¹‰å…¨å±€çš„è·å–é¡ºåº
2. **è¶…æ—¶æœºåˆ¶**ï¼šè®¾ç½®è·å–é”çš„è¶…æ—¶æ—¶é—´
3. **é¿å…åµŒå¥—é”**ï¼šå°½é‡å‡å°‘é”çš„åµŒå¥—ä½¿ç”¨
4. **ä½¿ç”¨æ›´é«˜çº§çš„åŒæ­¥åŸè¯­**ï¼šå¦‚ `threading.RLock`ã€`threading.Semaphore`

### æ£€æµ‹æ–¹æ³•ï¼š

1. **ä»£ç å®¡æŸ¥**ï¼šæ£€æŸ¥é”çš„è·å–é¡ºåº
2. **é™æ€åˆ†æå·¥å…·**ï¼šä½¿ç”¨pylintç­‰å·¥å…·æ£€æŸ¥
3. **åŠ¨æ€æ£€æµ‹**ï¼šä½¿ç”¨çº¿ç¨‹åˆ†æå™¨
4. **è¶…æ—¶ç›‘æ§**ï¼šè®¾ç½®æ“ä½œè¶…æ—¶ï¼Œè¶…æ—¶åˆ™å¯èƒ½å­˜åœ¨æ­»é”

## å®é™…åº”ç”¨ä¸­çš„å»ºè®®

```python
# å®ç”¨æ¨¡æ¿ï¼šå®‰å…¨çš„èµ„æºç®¡ç†
class SafeResourceManager:
    def __init__(self):
        self.locks = {}
  
    def safe_operation(self, resource_ids):
        """å®‰å…¨åœ°æ“ä½œå¤šä¸ªèµ„æº"""
        # 1. æŒ‰å›ºå®šé¡ºåºæ’åºèµ„æºID
        sorted_ids = sorted(resource_ids)
  
        # 2. æŒ‰é¡ºåºè·å–æ‰€æœ‰é”
        acquired_locks = []
        try:
            for res_id in sorted_ids:
                lock = self._get_lock(res_id)
                lock.acquire(timeout=5.0)  # è®¾ç½®è¶…æ—¶
                acquired_locks.append(lock)
      
            # 3. æ‰§è¡Œæ“ä½œ
            return self._do_operation(resource_ids)
      
        finally:
            # 4. é€†åºé‡Šæ”¾é”ï¼ˆè‰¯å¥½å®è·µï¼‰
            for lock in reversed(acquired_locks):
                lock.release()
  
    def _get_lock(self, res_id):
        # è·å–æˆ–åˆ›å»ºé”
        pass
  
    def _do_operation(self, resource_ids):
        # æ‰§è¡Œå®é™…æ“ä½œ
        pass
```

## æ€»ç»“

æ­»é”æ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„å¸¸è§é—®é¢˜ï¼Œç†è§£å…¶äº§ç”Ÿæ¡ä»¶å’Œè§£å†³æ–¹æ¡ˆè‡³å…³é‡è¦ã€‚åœ¨Pythonä¸­ï¼š

1. **ç»å…¸æ­»é”åœºæ™¯**åŒ…æ‹¬å“²å­¦å®¶å°±é¤ã€é“¶è¡Œè½¬è´¦ã€åµŒå¥—é”
2. **è§£å†³æ–¹æ¡ˆ**ï¼šå›ºå®šé”é¡ºåº > è¶…æ—¶æœºåˆ¶ > ä½¿ç”¨é«˜çº§åŒæ­¥åŸè¯­
3. **æœ€ä½³å®è·µ**ï¼šæ€»æ˜¯æŒ‰ç›¸åŒé¡ºåºè·å–é”ï¼Œä½¿ç”¨ `with`è¯­å¥ç®¡ç†é”ï¼Œè®¾ç½®åˆç†çš„è¶…æ—¶

é€šè¿‡åˆç†çš„è®¾è®¡å’Œé¢„é˜²ï¼Œå¯ä»¥å¤§å¤§é™ä½æ­»é”å‘ç”Ÿçš„æ¦‚ç‡ã€‚
